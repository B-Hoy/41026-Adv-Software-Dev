trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
- task: DownloadSecureFile@1
  name: secret_token_file
  inputs:
    secureFile: 'settings.xml'
stages:
- stage: 'Build'
  displayName: 'Build app'
  - task: Maven@4
    inputs:
      mavenPOMFile: 'pom.xml'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.17'
      mavenOptions: '-Xmx1024m -Drevision=$(Build.BuildNumber)'
      options: '-s $(secret_token_file.secureFilePath)'
      goals: 'deploy'

- stage: 'Deploy'
    displayName: 'Deploy the web application'
    dependsOn: Build
    jobs:
    - deployment: Deploy
      pool:
        vmImage: 'ubuntu-20.04'
      environment: dev
      variables:
      - group: Release
      strategy:
        runOnce:
          deploy:
            steps:
            - download: current
              artifact: drop
            - task: AzureWebApp@1
              displayName: 'Azure App Service Deploy: website'
              inputs:
                azureSubscription: 'Resource Manager - Tailspin - Space Game'
                appName: '$(WebAppName)'
                package: '$(Pipeline.Workspace)/drop/$(buildConfiguration)/*.zip'
